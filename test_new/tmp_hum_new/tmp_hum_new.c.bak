#include <reg52.h>
#include "delay.h"
#include "uart.h"
#include "tmp_hum_new.h"

sbit dh11 = P2^7;
unsigned char dh_datatemp[5];
unsigned char dh_data[2];
unsigned char DH11_readbyte()
{
	  unsigned char i,datatemp;
	  datatemp = 0x00;
	  for(i = 0; i < 8; i++)
	  {
        while(!dh11);
			  datatemp <<= 1;
			  delay_us(15);
			  if(dh11 == 1)
				{
					  while(dh11);
					  datatemp = datatemp | 0x01;
        }		  
    }
		return datatemp;
}

unsigned char DH11_init()
{
	  dh11 = 1;
	  dh11 = 0;
	  delay_ms(21);
	  dh11 = 1;
	  delay_us(10);
	  if(dh11 == 0)
		{
        while(!dh11);
			  if(dh11 == 1)
				{
            while(dh11);
					  return 1;
        }
		}
		return 0;
}

unsigned char DH11_readdata()
{
    unsigned char i,temp;
	  if(DH11_init() == 1)
		{
        for(i = 0; i < 5; i++)
			  {
            dh_datatemp[i] = DH11_readbyte();
        }
			  if(dh_datatemp[4] == dh_datatemp[0] + dh_datatemp[1] + dh_datatemp[2] + dh_datatemp[3])
				{
					  temp = dh_datatemp[0] >> 4;
						dh_data[0] = temp * 16 + (dh_datatemp[0] & 0x0f);
						uart_send_byte(dh_data[0]);
            temp = dh_datatemp[2] >> 4;
						dh_data[1] = temp * 16 + (dh_datatemp[2] & 0x0f);
						uart_send_byte(dh_data[1]);
					  return 1;
        }
    }
		return 0;
}
