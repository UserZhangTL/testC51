C51 COMPILER V9.53.0.0   PCF8563                                                           07/29/2016 19:21:39 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE PCF8563
OBJECT MODULE PLACED IN PCF8563.obj
COMPILER INVOKED BY: C:\Keil_MDK\C51\BIN\C51.EXE PCF8563\PCF8563.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\delay;.\uart;
                    -.\NRF24L01__Receiver;.\LED16_64;.\WifiESP8266;.\PCF8563;.\DS18B20) DEBUG OBJECTEXTEND PRINT(.\PCF8563.lst) TABS(2) OBJEC
                    -T(PCF8563.obj)

line level    source

   1          #include "AllFunc.h"
   2          
   3          
   4          extern uchar TX_buf[10];
   5          extern void uart_test(unsigned char length);
   6          sbit SDA=P1^6;
   7          sbit SCL=P1^7;
   8          unsigned char Time_Buf_ASCII[100] = {0};//用于输出纯ASCII码的字符串
   9          unsigned char TX_buf[10];
  10          
  11          
  12          uchar g8563_Store[6]; /*时间交换区,全局变量声明*/
  13          uchar code c8563_Store[6]={0x16,0x05,0x25,0x16,0x23,0x00}; /*写入时间初值：星期一 07:59:00*/
  14          //uchar code c8563_Store[6]={0x01,0x02,0x03,0x04,0x05,0x05};
  15          /********************************************
  16          内部函数，延时1
  17          ********************************************/
  18          void Delay()
  19          {
  20   1          _nop_();_nop_(); _nop_();_nop_();_nop_();_nop_();/*根据晶振频率制定延时时间*/
  21   1      }
  22          /********************************************
  23          内部函数，I2C开始
  24          ********************************************/
  25          void Start()
  26          { 
  27   1          SDA=1;
  28   1            SCL=1;
  29   1            Delay();
  30   1            SDA=0;
  31   1            Delay();
  32   1            SCL=0;
  33   1        
  34   1      
  35   1      }
  36          /********************************************
  37          内部函数，I2C结束
  38          ********************************************/
  39          void Stop()
  40          {
  41   1            SDA=0;
  42   1            SCL=0;
  43   1            Delay();
  44   1            SCL=1;
  45   1            Delay();
  46   1            SDA=1;
  47   1            Delay();
  48   1      }
  49          /********************************************
  50          内部函数，输出ACK ,每个字节传输完成，输出ack=0,结束读书据，ack=1;
  51          ********************************************/
  52          void WriteACK(uchar ack)
  53          {
C51 COMPILER V9.53.0.0   PCF8563                                                           07/29/2016 19:21:39 PAGE 2   

  54   1          SDA=ack;
  55   1            Delay();
  56   1            SCL=1;
  57   1            Delay();
  58   1            SCL=0;
  59   1      }
  60          /********************************************
  61          内部函数，等待ACK
  62          ********************************************/
  63          void WaitACK()
  64          {  
  65   1          uchar errtime=20;
  66   1            SDA=1;
  67   1            Delay(); /*读ACK*/
  68   1            SCL=1;
  69   1            Delay();
  70   1            while(SDA)
  71   1            {  
  72   2              errtime--;
  73   2                  if(!errtime) 
  74   2                  Stop();
  75   2            }
  76   1            SCL=0;
  77   1            Delay();
  78   1      }
  79          /********************************************
  80          内部函数.输出数据字节
  81          入口:B=数据
  82          ********************************************/
  83          void writebyte(uchar wdata)
  84          {
  85   1          uchar i;
  86   1            for(i=0;i<8;i++)
  87   1            {
  88   2                  if(wdata&0x80) 
  89   2                  SDA=1;
  90   2                  else 
  91   2                  SDA=0;
  92   2                  wdata<<=1;
  93   2                  SCL=1;
  94   2                  Delay();
  95   2                  SCL=0;
  96   2            }
  97   1            WaitACK();     //I2C器件或通讯出错，将会退出I2C通讯
  98   1      }
  99          /********************************************
 100          内部函数.输入数据
 101          出口:B
 102          ********************************************/
 103          uchar Readbyte()
 104          {
 105   1          uchar i,bytedata;
 106   1            SDA=1;
 107   1            for(i=0;i<8;i++)
 108   1            {
 109   2                  SCL=1; 
 110   2                  bytedata<<=1;
 111   2                  bytedata|=SDA;
 112   2                  SCL=0;
 113   2                  Delay();
 114   2            }
 115   1            return(bytedata);
C51 COMPILER V9.53.0.0   PCF8563                                                           07/29/2016 19:21:39 PAGE 3   

 116   1      }
 117          /********************************************
 118          输出数据->pcf8563
 119          ********************************************/
 120          void writeData(uchar address,uchar mdata)
 121          {
 122   1          Start();
 123   1            writebyte(0xa2); /*写命令*/
 124   1          writebyte(address); /*写地址*/
 125   1            writebyte(mdata); /*写数据*/
 126   1          Stop();
 127   1      }
 128          /********************************************
 129          输入数据<-pcf8563
 130          ********************************************/
 131          /*uchar ReadData(uchar address) //单字节
 132          {  
 133              uchar rdata;
 134                Start();
 135                writebyte(0xa2); //写命令
 136                writebyte(address); //写地址
 137                Start();
 138                writebyte(0xa3); //读命令
 139                rdata=Readbyte();
 140                WriteACK(1);
 141                Stop();
 142                return(rdata);
 143          } */
 144          void ReadData1(uchar address,uchar count,uchar * buff) /*多字节*/
 145          {  
 146   1          uchar i;
 147   1            Start();
 148   1            writebyte(0xa2); /*写命令*/
 149   1            writebyte(address); /*写地址*/
 150   1            Start();
 151   1            writebyte(0xa3); /*读命令*/
 152   1            for(i=0;i<count;i++)
 153   1            {
 154   2                buff[i]=Readbyte();
 155   2                  if(i<count-1) 
 156   2                  WriteACK(0);
 157   2            }
 158   1            WriteACK(1);
 159   1              Stop();
 160   1      }  
 161          /********************************************
 162          内部函数,读入时间到内部缓冲区
 163          ********************************************/
 164          void P8563_Read()
 165          {   
 166   1          uchar time[7];
 167   1          int real_int_time[7] = 0;
 168   1          
 169   1          int len = 0;
 170   1        
 171   1          ReadData1(0x02,0x07,time);
 172   1          /*读出原始的BCD码表示的时间信息*/
 173   1          g8563_Store[0]=time[0]&0x7f; /*秒 */
 174   1          g8563_Store[1]=time[1]&0x7f; /*分 */
 175   1          g8563_Store[2]=time[2]&0x3f; /*小时 */
 176   1          g8563_Store[3]=time[3]&0x3f; /*日 */
 177   1          g8563_Store[4]=time[5]&0x1f; /*月 */
C51 COMPILER V9.53.0.0   PCF8563                                                           07/29/2016 19:21:39 PAGE 4   

 178   1          g8563_Store[5]=time[6]; /*年  */
 179   1          /*转存到buf中*/
 180   1          TX_buf[0] = g8563_Store[5];
 181   1          TX_buf[1] = g8563_Store[4];
 182   1          TX_buf[2] = g8563_Store[3];
 183   1          TX_buf[3] = g8563_Store[2]; 
 184   1          TX_buf[4] = g8563_Store[1]; 
 185   1          TX_buf[5] = g8563_Store[0]; 
 186   1          /*将BCD码形式的十六进制数据转化为十进制数据*/
 187   1          real_int_time[0] = (TX_buf[0] % 16) + ((TX_buf[0] / 16)*10);
 188   1          real_int_time[1] = (TX_buf[1] % 16) + ((TX_buf[1] / 16)*10);
 189   1          real_int_time[2] = (TX_buf[2] % 16) + ((TX_buf[2] / 16)*10);
 190   1          real_int_time[3] = (TX_buf[3] % 16) + ((TX_buf[3] / 16)*10);
 191   1          real_int_time[4] = (TX_buf[4] % 16) + ((TX_buf[4] / 16)*10);
 192   1          real_int_time[5] = (TX_buf[5] % 16) + ((TX_buf[5] / 16)*10);
 193   1      //        uart_test(6);   
 194   1          /*拼接成字符串，待用*/
 195   1          sprintf(Time_Buf_ASCII,"20%02d\\%02d\\%02d %02d:%02d:%02d",
 196   1          real_int_time[0] ,real_int_time[1],real_int_time[2],real_int_time[3],real_int_time[4],real_int_time[5] ,
             -strlen(Time_Buf_ASCII)    );
 197   1          /*测试打印*/
 198   1          //uart_sendstr(Time_Buf_ASCII);
 199   1          
 200   1          //清空操作要在用完之后，其实也不需要，反正长度都一样
 201   1          //memset(Time_Buf_ASCII,0,sizeof(Time_Buf_ASCII));
 202   1        
 203   1      }
 204          /********************************************
 205          读入时间到内部缓冲区----外部调用 
 206          ********************************************/
 207          void P8563_gettime()
 208          {
 209   1            P8563_Read();
 210   1            if(g8563_Store[0]==0)
 211   1                  P8563_Read(); /*如果为秒=0，为防止时间变化，再读一次*/
 212   1      } 
 213          /********************************************
 214          写时间修改值
 215          ********************************************/
 216          void P8563_settime()
 217          {
 218   1            //uchar i;
 219   1          writeData(8,g8563_Store[0]); //年 
 220   1          writeData(7,g8563_Store[1]); //月 
 221   1          writeData(5,g8563_Store[2]); //日 
 222   1          writeData(4,g8563_Store[3]); //时 
 223   1          writeData(3,g8563_Store[4]); //分  
 224   1          writeData(2,g8563_Store[5]); //秒 
 225   1      }
 226          /********************************************
 227          P8563的初始化-----外部调用
 228          ********************************************/
 229          void P8563_init()
 230          {
 231   1          uchar i;
 232   1          
 233   1          for(i=0;i<=5;i++) 
 234   1              g8563_Store[i]=c8563_Store[i]; /*初始化时间*/
 235   1          P8563_settime();  
 236   1      }
 237          

C51 COMPILER V9.53.0.0   PCF8563                                                           07/29/2016 19:21:39 PAGE 5   


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    756    ----
   CONSTANT SIZE    =     52    ----
   XDATA SIZE       =    116      26
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
