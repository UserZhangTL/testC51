#include <reg52.h>
#include "uart.h"

void uart_init()
{
	  SCON = 0x50;//设置串口工作方式，允许接收
	  TMOD = 0x20;//定时器1工作在8位自动重装
	  TH1 = 0xfa;//比特率为9600时的初值
	  TR1 = 1;//打开定时器1
	  
	  EA = 1;//总中断
	  ES = 1;//串口中断
}

void uart_sendbyte(unsigned char byte)//发送一个字符
{
	  SBUF = byte;
	  while(!TI);
	  TI = 0;
}

void uart_sendstr(unsigned char *s)//发送一个字符串
{
	  while(*s)
		{
			  uart_sendbyte(*s);
			  s ++;
		}
}

//中断服务函数，用于软复位
void uart_isr() interrupt 4
{
	  static unsigned char i = 0;
	  unsigned char temp;
	  ES = 0;
	  temp = SBUF;
	  if(0x7f == temp)
		{
			  i ++;
			  if(10 == i)
				{
					  i = 0;
					  ISP_CONTR = 0xe0;
        }
		}
		else
		{
			  i = 0;
		}
		RI = 0;
		ES = 1;
}